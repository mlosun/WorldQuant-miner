<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alpha 生成器仪表盘</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .header h1 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .status-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .status-card h3 {
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
        }
        
        .status-active { background-color: #4CAF50; }
        .status-error { background-color: #f44336; }
        .status-warning { background-color: #ff9800; }
        .status-unknown { background-color: #9e9e9e; }
        
        .metric {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 5px 0;
        }
        
        .metric-label {
            font-weight: 500;
            color: #666;
        }
        
        .metric-value {
            font-weight: 600;
            color: #333;
        }
        
        .controls {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .controls h3 {
            color: #333;
            margin-bottom: 15px;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        .logs-section {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .logs-section h3 {
            color: #333;
            margin-bottom: 15px;
        }
        
        .logs-container {
            background: #1e1e1e;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .activity-item {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        
        .activity-time {
            color: #666;
            font-size: 12px;
        }
        
        .activity-message {
            color: #333;
            margin-top: 2px;
        }
        
        .refresh-info {
            text-align: center;
            color: #666;
            font-size: 14px;
            margin-top: 10px;
        }
        
        @media (max-width: 768px) {
            .status-grid {
                grid-template-columns: 1fr;
            }
            
            .button-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Alpha 生成器仪表盘</h1>
            <p>Alpha Orchestrator 的实时监控与控制</p>
        </div>
        
        <div class="status-grid" id="statusGrid">
            <!-- Status cards will be populated here -->
        </div>
        
        <div class="controls">
            <h3>Manual Controls</h3>
            <div class="button-group">
                <button class="btn btn-primary" onclick="refreshStatus()">Refresh Status</button>
                <button class="btn btn-success" onclick="triggerMining()">Trigger Mining</button>
                <button class="btn btn-warning" onclick="triggerSubmission()">Trigger Submission</button>
                <button class="btn btn-primary" onclick="triggerAlphaGeneration()">Generate Alpha</button>
                <a href="http://localhost:3000" target="_blank" class="btn btn-primary">Ollama WebUI</a>
                <a href="http://localhost:11434/api/tags" target="_blank" class="btn btn-primary">Ollama API</a>
            </div>
        </div>
        
        <div class="logs-section">
            <h3>Recent Activity</h3>
            <div id="activityContainer">
                <!-- Activity items will be populated here -->
            </div>
        </div>
        
        <div class="logs-section">
            <h3>Alpha Generator Logs</h3>
            <div class="logs-container" id="alphaLogsContainer">
                <!-- Alpha generator logs will be populated here -->
            </div>
        </div>
        
        <div class="logs-section">
            <h3>All System Logs</h3>
            <div class="logs-container" id="logsContainer">
                <!-- All logs will be populated here -->
            </div>
        </div>
        
        <div class="refresh-info">
            Auto-refresh every 30 seconds | Last updated: <span id="lastUpdate">Never</span>
        </div>
    </div>

    <script>
        let statusData = {};
        
        function updateStatusIndicator(status) {
            switch(status) {
                case 'active':
                case 'running':
                case 'connected':
                    return 'status-active';
                case 'error':
                case 'failed':
                case 'auth_failed':
                    return 'status-error';
                case 'warning':
                case 'not_responding':
                    return 'status-warning';
                default:
                    return 'status-unknown';
            }
        }
        
        function formatTimestamp(timestamp) {
            if (!timestamp) return 'N/A';
            const date = new Date(timestamp);
            return date.toLocaleString();
        }
        
        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        function updateStatusGrid() {
            const grid = document.getElementById('statusGrid');
            grid.innerHTML = '';
            
            // GPU Status
            const gpu = statusData.gpu || {};
            grid.innerHTML += `
                <div class="status-card">
                    <h3><span class="status-indicator ${updateStatusIndicator(gpu.status)}"></span>GPU Status</h3>
                    <div class="metric">
                        <span class="metric-label">Status:</span>
                        <span class="metric-value">${gpu.status || 'Unknown'}</span>
                    </div>
                    ${gpu.name ? `<div class="metric">
                        <span class="metric-label">GPU:</span>
                        <span class="metric-value">${gpu.name}</span>
                    </div>` : ''}
                    ${gpu.memory_used_mb ? `<div class="metric">
                        <span class="metric-label">Memory:</span>
                        <span class="metric-value">${gpu.memory_used_mb}MB / ${gpu.memory_total_mb}MB (${gpu.memory_percent}%)</span>
                    </div>` : ''}
                    ${gpu.utilization_percent ? `<div class="metric">
                        <span class="metric-label">Utilization:</span>
                        <span class="metric-value">${gpu.utilization_percent}%</span>
                    </div>` : ''}
                    ${gpu.temperature_c ? `<div class="metric">
                        <span class="metric-label">Temperature:</span>
                        <span class="metric-value">${gpu.temperature_c}°C</span>
                    </div>` : ''}
                </div>
            `;
            
            // Ollama Status
            const ollama = statusData.ollama || {};
            grid.innerHTML += `
                <div class="status-card">
                    <h3><span class="status-indicator ${updateStatusIndicator(ollama.status)}"></span>Ollama Status</h3>
                    <div class="metric">
                        <span class="metric-label">Status:</span>
                        <span class="metric-value">${ollama.status || 'Unknown'}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Models:</span>
                        <span class="metric-value">${ollama.model_count || 0}</span>
                    </div>
                    ${ollama.models ? `<div class="metric">
                        <span class="metric-label">Loaded:</span>
                        <span class="metric-value">${ollama.models.join(', ') || 'None'}</span>
                    </div>` : ''}
                </div>
            `;
            
            // Orchestrator Status
            const orchestrator = statusData.orchestrator || {};
            grid.innerHTML += `
                <div class="status-card">
                    <h3><span class="status-indicator ${updateStatusIndicator(orchestrator.status)}"></span>Orchestrator Status</h3>
                    <div class="metric">
                        <span class="metric-label">Status:</span>
                        <span class="metric-value">${orchestrator.status || 'Unknown'}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Mode:</span>
                        <span class="metric-value">${orchestrator.current_mode || 'Unknown'}</span>
                    </div>
                    ${orchestrator.next_mining ? `<div class="metric">
                        <span class="metric-label">Next Mining:</span>
                        <span class="metric-value">${formatTimestamp(orchestrator.next_mining)}</span>
                    </div>` : ''}
                    ${orchestrator.next_submission ? `<div class="metric">
                        <span class="metric-label">Next Submission:</span>
                        <span class="metric-value">${formatTimestamp(orchestrator.next_submission)}</span>
                    </div>` : ''}
                </div>
            `;
            
            // WorldQuant Status
            const worldquant = statusData.worldquant || {};
            grid.innerHTML += `
                <div class="status-card">
                    <h3><span class="status-indicator ${updateStatusIndicator(worldquant.status)}"></span>WorldQuant Brain</h3>
                    <div class="metric">
                        <span class="metric-label">Status:</span>
                        <span class="metric-value">${worldquant.status || 'Unknown'}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Message:</span>
                        <span class="metric-value">${worldquant.message || 'N/A'}</span>
                    </div>
                </div>
            `;
            
            // Statistics
            const stats = statusData.statistics || {};
            grid.innerHTML += `
                <div class="status-card">
                    <h3><span class="status-indicator status-active"></span>Statistics</h3>
                    <div class="metric">
                        <span class="metric-label">Total Generated:</span>
                        <span class="metric-value">${stats.total_alphas_generated || 0}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Successful:</span>
                        <span class="metric-value">${stats.successful_alphas || 0}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Last 24h Generated:</span>
                        <span class="metric-value">${stats.last_24h_generated || 0}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Last 24h Successful:</span>
                        <span class="metric-value">${stats.last_24h_successful || 0}</span>
                    </div>
                </div>
            `;
        }
        
        function updateActivity() {
            const container = document.getElementById('activityContainer');
            const activities = statusData.recent_activity || [];
            
            container.innerHTML = '';
            activities.forEach(activity => {
                container.innerHTML += `
                    <div class="activity-item">
                        <div class="activity-time">${formatTimestamp(activity.timestamp)}</div>
                        <div class="activity-message">${activity.message}</div>
                    </div>
                `;
            });
        }
        
        async function loadLogs() {
            try {
                const response = await fetch('/api/logs?lines=20');
                const data = await response.json();
                const logsContainer = document.getElementById('logsContainer');
                logsContainer.textContent = data.logs.join('\n');
            } catch (error) {
                console.error('Error loading logs:', error);
            }
        }
        
        async function loadAlphaLogs() {
            try {
                const response = await fetch('/api/alpha_logs?lines=30');
                const data = await response.json();
                const alphaLogsContainer = document.getElementById('alphaLogsContainer');
                alphaLogsContainer.textContent = data.logs.join('\n');
            } catch (error) {
                console.error('Error loading alpha logs:', error);
            }
        }
        
        async function refreshStatus() {
            try {
                const response = await fetch('/api/status');
                statusData = await response.json();
                
                updateStatusGrid();
                updateActivity();
                loadLogs();
                loadAlphaLogs();
                
                document.getElementById('lastUpdate').textContent = new Date().toLocaleString();
            } catch (error) {
                console.error('Error refreshing status:', error);
            }
        }
        
        async function triggerMining() {
            try {
                const response = await fetch('/api/trigger_mining', { method: 'POST' });
                const result = await response.json();
                alert(result.success ? 'Mining triggered successfully!' : 'Error triggering mining: ' + result.error);
                refreshStatus();
            } catch (error) {
                alert('Error triggering mining: ' + error);
            }
        }
        
        async function triggerSubmission() {
            try {
                const response = await fetch('/api/trigger_submission', { method: 'POST' });
                const result = await response.json();
                alert(result.success ? 'Submission triggered successfully!' : 'Error triggering submission: ' + result.error);
                refreshStatus();
            } catch (error) {
                alert('Error triggering submission: ' + error);
            }
        }
        
        async function triggerAlphaGeneration() {
            try {
                const response = await fetch('/api/trigger_alpha_generation', { method: 'POST' });
                const result = await response.json();
                alert(result.success ? 'Alpha generation triggered successfully!' : 'Error triggering alpha generation: ' + result.error);
                refreshStatus();
            } catch (error) {
                alert('Error triggering alpha generation: ' + error);
            }
        }
        
        // Initial load
        refreshStatus();
        
        // Auto-refresh every 30 seconds
        setInterval(refreshStatus, 30000);
    </script>
</body>
</html>
